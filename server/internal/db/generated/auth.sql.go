// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: auth.sql

package db

import (
	"context"
	"time"

	"github.com/google/uuid"
)

const cleanupExpiredSessions = `-- name: CleanupExpiredSessions :exec
DELETE FROM user_sessions
WHERE expires_at < NOW()
`

func (q *Queries) CleanupExpiredSessions(ctx context.Context) error {
	_, err := q.exec(ctx, q.cleanupExpiredSessionsStmt, cleanupExpiredSessions)
	return err
}

const cleanupExpiredTokens = `-- name: CleanupExpiredTokens :exec
DELETE FROM magic_link_tokens
WHERE expires_at < NOW() OR used_at IS NOT NULL
`

func (q *Queries) CleanupExpiredTokens(ctx context.Context) error {
	_, err := q.exec(ctx, q.cleanupExpiredTokensStmt, cleanupExpiredTokens)
	return err
}

const createMagicLinkToken = `-- name: CreateMagicLinkToken :one
INSERT INTO magic_link_tokens (
  token, user_uuid, expires_at, purpose
) VALUES (
  $1, $2, $3, $4
)
RETURNING id, token, user_uuid, expires_at, used_at, created_at, purpose
`

type CreateMagicLinkTokenParams struct {
	Token     string    `json:"token"`
	UserUuid  uuid.UUID `json:"user_uuid"`
	ExpiresAt time.Time `json:"expires_at"`
	Purpose   string    `json:"purpose"`
}

func (q *Queries) CreateMagicLinkToken(ctx context.Context, arg CreateMagicLinkTokenParams) (MagicLinkToken, error) {
	row := q.queryRow(ctx, q.createMagicLinkTokenStmt, createMagicLinkToken,
		arg.Token,
		arg.UserUuid,
		arg.ExpiresAt,
		arg.Purpose,
	)
	var i MagicLinkToken
	err := row.Scan(
		&i.ID,
		&i.Token,
		&i.UserUuid,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.CreatedAt,
		&i.Purpose,
	)
	return i, err
}

const createUserSession = `-- name: CreateUserSession :one
INSERT INTO user_sessions (
  session_id, user_uuid, expires_at
) VALUES (
  $1, $2, $3
)
RETURNING id, session_id, user_uuid, expires_at, created_at, last_used_at
`

type CreateUserSessionParams struct {
	SessionID string    `json:"session_id"`
	UserUuid  uuid.UUID `json:"user_uuid"`
	ExpiresAt time.Time `json:"expires_at"`
}

func (q *Queries) CreateUserSession(ctx context.Context, arg CreateUserSessionParams) (UserSession, error) {
	row := q.queryRow(ctx, q.createUserSessionStmt, createUserSession, arg.SessionID, arg.UserUuid, arg.ExpiresAt)
	var i UserSession
	err := row.Scan(
		&i.ID,
		&i.SessionID,
		&i.UserUuid,
		&i.ExpiresAt,
		&i.CreatedAt,
		&i.LastUsedAt,
	)
	return i, err
}

const deleteUserSession = `-- name: DeleteUserSession :exec
DELETE FROM user_sessions
WHERE session_id = $1
`

func (q *Queries) DeleteUserSession(ctx context.Context, sessionID string) error {
	_, err := q.exec(ctx, q.deleteUserSessionStmt, deleteUserSession, sessionID)
	return err
}

const getMagicLinkToken = `-- name: GetMagicLinkToken :one
SELECT id, token, user_uuid, expires_at, used_at, created_at, purpose FROM magic_link_tokens
WHERE token = $1 AND expires_at > NOW() AND used_at IS NULL
LIMIT 1
`

func (q *Queries) GetMagicLinkToken(ctx context.Context, token string) (MagicLinkToken, error) {
	row := q.queryRow(ctx, q.getMagicLinkTokenStmt, getMagicLinkToken, token)
	var i MagicLinkToken
	err := row.Scan(
		&i.ID,
		&i.Token,
		&i.UserUuid,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.CreatedAt,
		&i.Purpose,
	)
	return i, err
}

const getUserSession = `-- name: GetUserSession :one
SELECT id, session_id, user_uuid, expires_at, created_at, last_used_at FROM user_sessions
WHERE session_id = $1 AND expires_at > NOW()
LIMIT 1
`

func (q *Queries) GetUserSession(ctx context.Context, sessionID string) (UserSession, error) {
	row := q.queryRow(ctx, q.getUserSessionStmt, getUserSession, sessionID)
	var i UserSession
	err := row.Scan(
		&i.ID,
		&i.SessionID,
		&i.UserUuid,
		&i.ExpiresAt,
		&i.CreatedAt,
		&i.LastUsedAt,
	)
	return i, err
}

const getUserWithVerification = `-- name: GetUserWithVerification :one
SELECT id, uuid, email, phone, created_at, email_verified, verified_at FROM users
WHERE uuid = $1 LIMIT 1
`

func (q *Queries) GetUserWithVerification(ctx context.Context, argUuid uuid.UUID) (User, error) {
	row := q.queryRow(ctx, q.getUserWithVerificationStmt, getUserWithVerification, argUuid)
	var i User
	err := row.Scan(
		&i.ID,
		&i.Uuid,
		&i.Email,
		&i.Phone,
		&i.CreatedAt,
		&i.EmailVerified,
		&i.VerifiedAt,
	)
	return i, err
}

const markEmailVerified = `-- name: MarkEmailVerified :exec
UPDATE users
SET email_verified = TRUE, verified_at = NOW()
WHERE uuid = $1
`

func (q *Queries) MarkEmailVerified(ctx context.Context, argUuid uuid.UUID) error {
	_, err := q.exec(ctx, q.markEmailVerifiedStmt, markEmailVerified, argUuid)
	return err
}

const updateSessionLastUsed = `-- name: UpdateSessionLastUsed :exec
UPDATE user_sessions
SET last_used_at = NOW()
WHERE session_id = $1
`

func (q *Queries) UpdateSessionLastUsed(ctx context.Context, sessionID string) error {
	_, err := q.exec(ctx, q.updateSessionLastUsedStmt, updateSessionLastUsed, sessionID)
	return err
}

const useMagicLinkToken = `-- name: UseMagicLinkToken :exec
UPDATE magic_link_tokens
SET used_at = NOW()
WHERE token = $1
`

func (q *Queries) UseMagicLinkToken(ctx context.Context, token string) error {
	_, err := q.exec(ctx, q.useMagicLinkTokenStmt, useMagicLinkToken, token)
	return err
}
